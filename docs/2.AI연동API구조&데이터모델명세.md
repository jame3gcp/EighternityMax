# ② AI 연동 API 구조 & 데이터 모델 명세 (OAuth 가입/로그인 반영 버전)

목적:  
OAuth로 빠른 가입/로그인 → 최소 정보 입력 → 서버가 AI 분석 생성 → 정제/구조화하여  
사이클/가이드/예보/방향/지도/행운 기능에서 공통 사용

---

## 1. 인증/가입 아키텍처 (OAuth)

### 지원 OAuth Provider (예)
- Kakao / Naver / Google / Apple (모바일 고려 시 Apple 권장)

### 토큰 전략(권장)
- FE는 Provider 로그인 → `authorization code` 획득
- BE가 code로 provider 토큰 교환 → 사용자 식별
- 서비스용 토큰 발급:
  - `access_token` (짧게)
  - `refresh_token` (길게, httpOnly cookie 권장)

---

## 2. 사용자 플로우 (OAuth 포함)

1) OAuth 로그인 (최초면 자동 가입)
2) 서비스 토큰 발급/세션 생성
3) 프로필 최소 입력(생년월일/출생시간/성별/지역 선택)
4) AI Personal Energy Modeling 생성
5) Home 진입 후 기능 순환

---

## 3. API 엔드포인트 (OAuth 포함)

### 3.1 OAuth 로그인 시작(선택: 서버 주도)
`GET /v1/auth/oauth/{provider}/redirect`

- provider: `kakao|naver|google|apple`
- query:
  - redirect_uri (FE callback)
  - state (CSRF 방지)

**Response**
- 302 Redirect (provider authorize URL)

> FE 주도(OAuth SDK)로 구현하는 경우 이 엔드포인트 생략 가능

---

### 3.2 OAuth 콜백 교환(권장: 서버에서 code 교환)
`POST /v1/auth/oauth/{provider}/callback`

**Request**
- code: string
- redirect_uri: string
- state: string

**Response**
- user:
  - user_id
  - is_new_user: boolean
  - provider: string
- tokens:
  - access_token
  - refresh_token (또는 httpOnly cookie)
- next_step:
  - `profile_required|ready`

---

### 3.3 토큰 갱신
`POST /v1/auth/token/refresh`

**Request**
- refresh_token (또는 cookie 기반)

**Response**
- access_token (신규)
- refresh_token (rotation 시)

---

### 3.4 로그아웃
`POST /v1/auth/logout`
- refresh_token 폐기

---

## 4. 프로필/AI 생성 API (기존 유지 + OAuth 전제)

### 4.1 기본 정보 저장 (온보딩)
`POST /v1/users/me/profile`

**Request**
- birth_date: `YYYY-MM-DD`
- birth_time: `HH:mm` (nullable, unknown 허용)
- gender: `M|F|X`
- region: string (nullable)

**Response**
- profile_id
- status: `saved`
- next_step: `generate_life_profile`

> `/users/{userId}` 대신 `/users/me` 사용 권장 (OAuth 토큰 기반)

---

### 4.2 AI 분석 생성(비동기 권장)
`POST /v1/users/me/life-profile/generate`

**Request**
- profile_id
- options:
  - detail_level: `summary|standard|deep`
  - language: `ko`

**Response**
- job_id
- status: `queued|running`

---

### 4.3 AI 작업 상태 조회
`GET /v1/jobs/{jobId}`

**Response**
- status: `queued|running|done|failed`
- progress: 0~100
- result_ref (done일 때)

---

### 4.4 Life Profile 조회 (표준화 결과)
`GET /v1/users/me/life-profile`

**Response**
- life_profile (표준 모델)
- updated_at
- version

---

### 4.5 오늘 가이드
`GET /v1/users/me/daily-guide?date=YYYY-MM-DD`

---

### 4.6 30일 예보
`GET /v1/users/me/energy-forecast?from=YYYY-MM-DD&days=30`

---

### 4.7 인생 방향 가이드(카테고리)
`GET /v1/users/me/directions?date=YYYY-MM-DD`

---

### 4.8 에너지 스팟(지도 추천)
`GET /v1/users/me/spots?lat={}&lng={}&purpose={focus|rest|meet}&radius_km=3`

---

### 4.9 행운 번호(오락용)
`GET /v1/users/me/lucky-numbers?date=YYYY-MM-DD&type=lotto`

---

### 4.10 오늘 기록 저장
`POST /v1/users/me/daily-log`

---

## 5. OAuth 사용자 데이터 정책(최소 수집 원칙)

### 저장 권장
- user_id(내부)
- provider, provider_user_id(중복 가입 방지)
- email(제공되는 경우만, 선택)
- display_name(선택)
- created_at, last_login_at

### 수집/저장 비권장(또는 옵션)
- 프로바이더 access_token 장기 저장 (가능하면 미저장)
- 불필요한 개인정보

---

## 6. UI/UX 온보딩 규칙 (OAuth 반영)

### 상태별 라우팅

- `is_new_user = true` → **프로필 입력 화면으로**
- `profile_missing` → 프로필 입력
- `life_profile_missing` → 분석 생성 로딩
- `ready` → Home

### UX 포인트
- OAuth 로그인 후 바로 Home이 아니라,
  "내 분석을 만들기 위한 최소 정보 입력" 1 화면만 거치게 설계

---

## 7. 에러/예외 처리 (OAuth)

- Provider 인증 실패/취소:
  - 로그인 화면으로 복귀 + 안내 토스트
- state 불일치:
  - 보안 에러 처리 + 재시도 유도
- 동일 이메일/다른 provider:
  - 기본 정책 결정 필요
  - 권장: provider_user_id 기준 계정 생성, 사용자에게 “계정 연결” 옵션 제공(Phase2)

---

## 8. AI 응답 표준 모델 (정제 후 저장) – 동일

### LifeProfile / DailyGuide / Forecast / Directions JSON
- 기존 스키마 그대로 사용
- 단, `userId`는 OAuth 기반 `me`로 접근

---

## 9. 개발자 전달 핵심 요약

- ✔ 가입/로그인은 OAuth로 단순화
- ✔ OAuth 완료 후 **최소 입력(생년월일시/성별)**만 받아 AI 분석 생성
- ✔ 이후 기능은 `/users/me/*` 기반으로 일관성 유지
- ✔ 토큰: access/refresh + 보안(httpOnly cookie) 권장
- ✔ 계정 연결(여러 provider)은 Phase2로 분리 가능

---

## 10. 다음 단계(③)

- 추천/예측 로직 플로우(규칙표 + 우선순위)
- 화면별 Acceptance Criteria(테스트 기준)
- MVP/Phase2 기능 분리 WBS

원하시면 바로 이어서 **③ 추천/예측 로직 플로우** 작성하겠습니다.
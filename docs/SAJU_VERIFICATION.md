# 만세력(사주) 계산 검증

## 1. 기준 및 라이브러리

- **기준**: [한국천문연구원(KARI)](https://astro.kasi.re.kr/) 양음력 변환 기준
- **구현**: npm 패키지 `korean-lunar-calendar` 사용  
  - [GitHub: korean_lunar_calendar_js](https://github.com/usingsky/korean_lunar_calendar_js)  
  - README: "한국 양음력 변환 (한국천문연구원 기준)"
- **지원 범위**
  - 음력: 1000-01-01 ~ 2050-11-18
  - 양력: 1000-02-13 ~ 2050-12-31

## 2. 참조 사이트와의 대응

| 항목 | [beta-ybz6.onrender.com](https://beta-ybz6.onrender.com/) | 본 프로젝트 |
|------|-----------------------------------------------------------|-------------|
| 양력/음력 선택 | 지원 | 지원 (calendar_type) |
| 윤달 | 지원 | 지원 (is_intercalation) |
| 연주(년 간지) | 사주 4주 표시 | `saju.gapjaKorean.year` / `gapjaChinese.year` |
| 월주(월 간지) | 사주 4주 표시 | `saju.gapjaKorean.month` / `gapjaChinese.month` |
| 일주(일 간지) | 사주 4주 표시 | `saju.gapjaKorean.day` / `gapjaChinese.day` |
| 시주(시 간지) | 사주 4주 표시 | **지원** `saju.gapjaKorean.hour` / `gapjaChinese.hour` (일간+출생시각) |
| 성별 | 지원 | **지원** `saju.gender` (M/F/X) |
| 오행 분포 | 목·화·토·금·수 개수 | **지원** `saju.ohang.distribution` (개인정보로 저장) |
| 십성 | 연·월·일·시 천간별 | **지원** `saju.sipseong` (비견·겁재·식신·상관 등, 개인정보로 저장) |
| 12운성 | 연·월·일·시 지지별 | **지원** `saju.unseong12` (장생·목욕·관대 등, 개인정보로 저장) |
| 천간 특수관계 | 합/冲 | **지원** `saju.cheonganRelation` (주별) |
| 지지 형충회합 | 육합·삼합·반합·충·형·해·파·**암합** 등 | **지원** `saju.jijiRelation` (주별, 암합 포함) |
| 십이신살 | 역마·도화·화개 등 | **지원** `saju.sinsal12` (주별, 年支·日支 기준) |
| 대운 | 月柱 기준 순/역 8단계 | **지원** `saju.daeun` (한국천문연구원 기준, 起运岁数는 절기 데이터 필요) |
| 세운(년운) | 연도별 간지·십성·12운성 | **지원** `saju.seun` |
| 월운 | 월별 간지·십성·12운성 | **지원** `saju.woleun` (五虎遁, **당해년** 현재 연도 한국 기준, 1월=丑月 … 12월=子月) |

참조 사이트와 동일하게 **천간 특수관계**, **지지 형충회합 해석**, **십이신살·신살 종합**, **대운**, **세운**, **월운**을 계산하여 프로필(saju)에 포함합니다. **월운**은 당해년(현재 연도, Asia/Seoul 기준) 五虎遁으로 계산하며, 1월은 입춘 전이므로 전년 年干의 丑月으로 둡니다. 마이페이지 및 개발용 프로필 테스트 페이지에서 조회할 수 있습니다.

월운 검증 (1984.11.16 01:00 기준 참조 표와 비교):

```bash
cd backend && node scripts/woleun-verify.js
```

### 2.1 지지 형충회합 — 육합(六合)·암합(暗合) 참고 데이터

**육합**: 해당 주의 지지가 속한 六合 쌍을 항상 표시한다 (상대 지지가 사주에 없어도 표시). 예: 子→子丑, 寅/亥→寅亥.

**암합**: 고정 쌍 子戌·丑寅·寅未·午亥만 사용하며, 표기 형식은 주별로 참조와 동일하게 맞춘다. 참고 데이터 형식은 아래와 같다.

| 구분 | 참고 데이터 (천간地支·地支地支 형식) |
|------|--------------------------------------|
| **암합 시주** | 戊子, 子戌, 子戌 |
| **암합 일주** | 丑寅, 丑寅, 寅未, 寅未 |
| **암합 월주** | 午亥, 丁亥, 午亥 |
| **암합 연주** | 戊子, 子戌, 子戌 |

- 시주/연주: `天干地支, 地支地支, 地支地支` 순으로 표기
- 일주: `地支地支` 쌍만 반복 표기
- 월주: `地支地支, 天干地支, 地支地支` 순으로 표기

위 암합 참고 데이터는 **四柱가 戊子年 丁亥月 壬寅日 戊子时**(연子 月亥 日寅 時子)일 때의 결과이다. UI 테이블은 참조와 비교하기 쉽도록 **연주 → 월주 → 일주 → 시주** 순으로 표시한다.

- 암합의 **天干**(戊·丁 등)은 **해당 주의 천간**을 그대로 사용한다. 따라서 四柱가 다르면 천간도 다르게 나온다.
  - 예: 甲子年 乙亥月 壬寅日 甲子时이면 연주/시주에 **甲子**,子戌,子戌, 월주에 午亥,**乙亥**,午亥처럼 표시되는 것이 맞다.
  - 참고와 똑같이 보이려면 생년월일·시가 **戊子年 丁亥月 壬寅日 戊子时**가 나오는 날짜·시간으로 입력해야 한다.
- **시주** 첫 항목(시천간+시지)은 **日上起时(五鼠遁)** 기준이다. 戊子时가 나오려면 **일주 日干이 丙 또는 辛**이고 출생 시각이 子时(0~2시)여야 한다. 甲己日→甲子时, 乙庚日→丙子时, 丙辛日→戊子时, 丁壬日→庚子时, 戊癸日→壬子时.

특정 생년월일·시에 대해 `saju.jijiRelation[주].amhap`(또는 `ko.amhap`) 값이 참조 사이트와 위 형식으로 일치하는지 비교하면 된다. 참고 四柱(戊子 丁亥 壬寅 戊子)에 대한 암합 검증은 `backend/scripts/verify-amhap-reference.js`로 실행할 수 있다.

## 3. 검증 방법

### 3.1 자동 검증 (KARI/README 기준값)

아래 스크립트는 `korean-lunar-calendar` README에 나온 예시 날짜로 양력↔음력·간지 결과를 검증합니다.

```bash
cd backend && node scripts/verify-saju.js
```

검증 내용 요약:

- **양력 2017-06-24** → 음력 2017-05-01(윤달), 정유년 병오월 임오일
- **음력 1956-01-21(평달)** → 양력 1956-03-03, 병신년 경인월 기사일
- 양력 → 음력 → 양력, 음력(윤달) → 양력 → 음력 round-trip 일치

참조 사이트와 비교할 테스트 데이터 실행 및 보고서 생성:

```bash
cd backend && node scripts/saju-compare-with-reference.js
```

생성된 `docs/SAJU_COMPARE_RESULT.md`에서 **요약**, **참조 사이트와 수동 비교용 입력** 표, **케이스별 우리 결과**를 확인한 뒤 [beta-ybz6.onrender.com](https://beta-ybz6.onrender.com/)에 동일 입력으로 비교하면 됩니다.

### 3.2 참조 사이트와 수동 비교

**비교용 테스트 데이터**는 `backend/scripts/saju-compare-test-data.js`에 정의되어 있으며, 실행 결과는 `docs/SAJU_COMPARE_RESULT.md`에 기록됩니다. 보고서 상단의 **「참조 사이트와 수동 비교용 입력」** 표에 나온 대로 참조 사이트에 입력하면 됩니다.

1. [beta-ybz6.onrender.com](https://beta-ybz6.onrender.com/) 접속
2. **같은 날짜·시간·양력/음력·성별**을 입력 (표 참고)
3. 사주 4주 테이블에서 **연주·월주·일주·시주** 확인
   - 예: 연주 `정유년`, 월주 `병오월`, 일주 `임오일` 등
4. 본 서비스의 `saju.gapjaKorean` (또는 `gapjaChinese`)와 비교
   - 연주 ↔ `gapjaKorean.year`
   - 월주 ↔ `gapjaKorean.month`
   - 일주 ↔ `gapjaKorean.day`
5. **시주**: 동일 시간(시) 입력 시 참조 사이트 시주(시천간+시지)와 `saju.gapjaKorean.hour` / `gapjaChinese.hour` 비교 (日上起时 기준, 2시간 단위 시지)

### 3.3 API/프로필에서 확인

- 프로필 저장 시 `profiles.saju`에 연·월·일 간지가 저장됨
- `GET /v1/users/me/profile` 등으로 조회해 `saju.gapjaKorean` / `saju.gapjaChinese`와 참조 사이트 연·월·일주를 비교하면 됨

## 4. 정리

- **양력↔음력 변환**과 **연·월·일 간지**는 `korean-lunar-calendar`(KARI 기준)와 README 예시로 자동 검증됨.
- **참조 사이트( beta-ybz6 )**와는 같은 날짜를 넣었을 때 **연주·월주·일주**가 일치하는지 수동으로 비교하면 됨.
- 시주·오행·대운 등은 참조 사이트만 제공하며, 본 프로젝트에서는 검증 대상이 아님.
